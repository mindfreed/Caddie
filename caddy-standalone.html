<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Caddy</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            background: transparent;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
        }

        #prodigy-icon {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-image: url('/assets/caddy-mascot.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 10000;
            cursor: pointer;
            opacity: 0.4;
            filter: drop-shadow(0 0 6px #BE00FC);
            transition: all 0.3s ease;
        }

        #prodigy-icon.engaged {
            width: 200px;
            height: 200px;
            opacity: 1;
            filter: drop-shadow(0 0 15px #BE00FC);
        }

        #prodigy-icon:active {
            transform: scale(0.95);
        }

        #intel-bubble {
            display: none;
            position: fixed;
            bottom: 240px;
            right: 20px;
            width: 260px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00ff80;
            border-left: 5px solid #00ff80;
            padding: 15px;
            border-radius: 4px;
            color: #00ff80;
            box-shadow: 0 0 20px rgba(0, 255, 128, 0.2);
            z-index: 9999;
        }

        #intel-bubble.active {
            display: block;
        }

        h2 { margin: 0 0 8px 0; font-size: 13px; color: #BE00FC; text-transform: uppercase; letter-spacing: 1px; }
        p { margin: 0; font-size: 12px; line-height: 1.5; color: #fff; }
        .stat-row { display: flex; justify-content: space-between; margin-top: 10px; font-size: 11px; color: #aaa; font-weight: bold; }
        
        .alert-state {
            border-color: #ff3333 !important;
            border-left-color: #ff3333 !important;
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.4) !important;
        }
    </style>
</head>
<body>

    <div id="intel-bubble">
        <h2>Eyes On Target</h2>
        <p id="bubble-text">OVERSIGHT ACTIVE. GRID SECURE. TAP TO ACQUIRE TARGET.</p>
        <div id="offer-input" style="margin: 10px 0; display: none;">
            <input type="number" id="offer-amount" placeholder="Offer $" style="width: 80px; padding: 5px; background: #111; border: 1px solid #00ff80; color: #00ff80; font-family: inherit; font-size: 12px;">
            <button onclick="recalculate()" style="padding: 5px 10px; background: #00ff80; color: #000; border: none; cursor: pointer; font-family: inherit; font-size: 11px; font-weight: bold;">CALC</button>
        </div>
        <div class="stat-row">
            <span id="risk-stat">THREAT: --</span>
            <span id="ev-stat">VALUE: --</span>
        </div>
    </div>

    <div id="prodigy-icon" onclick="toggleIntel()"></div>

    <script>
        const icon = document.getElementById('prodigy-icon');
        const bubble = document.getElementById('intel-bubble');
        const text = document.getElementById('bubble-text');
        const riskStat = document.getElementById('risk-stat');
        const evStat = document.getElementById('ev-stat');
        const offerInput = document.getElementById('offer-input');
        const offerAmount = document.getElementById('offer-amount');
        
        let allianceStats = {};
        let isEngaged = false;
        let currentGame = null;
        let currentStats = null;

        fetch('/api/alliance-stats')
            .then(res => res.json())
            .then(data => {
                allianceStats = data;
            })
            .catch(e => {});

        function toggleIntel() {
            isEngaged = !isEngaged;
            
            if (isEngaged) {
                icon.classList.add('engaged');
                bubble.classList.add('active');
                runSnapScan();
            } else {
                icon.classList.remove('engaged');
                bubble.classList.remove('active');
                bubble.classList.remove('alert-state');
            }
        }

        async function runSnapScan() {
            text.innerText = "Scanning...";
            riskStat.innerText = "THREAT: --";
            evStat.innerText = "VALUE: --";
            bubble.classList.remove('alert-state');
            offerInput.style.display = 'none';
            
            try {
                const rawText = await navigator.clipboard.readText();
                const gameTitle = rawText.toLowerCase().trim();
                currentGame = rawText;
                
                setTimeout(() => {
                    const scoutReport = allianceStats[gameTitle];
                    currentStats = scoutReport;
                    
                    if (scoutReport) {
                        const isRisky = scoutReport.risk === 'high';
                        const isMed = scoutReport.risk === 'med';
                        
                        if (isRisky) {
                            text.innerHTML = `<b>${rawText.toUpperCase()}</b><br>Hold. High drag at <b>${scoutReport.cliff}</b>. Not worth your time.`;
                            bubble.classList.add('alert-state');
                        } else if (isMed) {
                            text.innerHTML = `<b>${rawText.toUpperCase()}</b><br>Proceed with caution. Watch for slowdown at <b>${scoutReport.cliff}</b>.`;
                        } else {
                            text.innerHTML = `<b>${rawText.toUpperCase()}</b><br>Clean shot. Push through <b>${scoutReport.cliff}</b> and collect.`;
                        }
                        riskStat.innerText = `THREAT: ${scoutReport.risk.toUpperCase()}`;
                        evStat.innerText = `VALUE: $${scoutReport.ev}/hr`;
                        offerInput.style.display = 'block';
                    } else {
                        text.innerHTML = `<b>${rawText.toUpperCase()}</b><br>No intel. Uncharted. Proceed at own risk.`;
                        riskStat.innerText = "THREAT: ???";
                        evStat.innerText = "VALUE: --";
                    }
                }, 600);
            } catch (err) {
                text.innerText = "Need clipboard access. Check permissions.";
            }
        }

        function recalculate() {
            const offer = parseFloat(offerAmount.value);
            if (!offer || !currentStats || !currentGame) return;
            
            const hours = currentStats.hours || 30;
            const customEV = (offer / hours).toFixed(2);
            
            let verdict = '';
            let threat = 'LOW';
            bubble.classList.remove('alert-state');
            
            if (customEV < 0.50) {
                verdict = `$${offer} for ${hours}hrs? That's $${customEV}/hr. Hard pass.`;
                threat = 'HIGH';
                bubble.classList.add('alert-state');
            } else if (customEV < 1.00) {
                verdict = `$${offer} = $${customEV}/hr over ${hours}hrs. Marginal. Only if idle time.`;
                threat = 'MED';
            } else {
                verdict = `$${offer} = $${customEV}/hr over ${hours}hrs. Solid rate. Execute.`;
                threat = 'LOW';
            }
            
            text.innerHTML = `<b>${currentGame.toUpperCase()}</b><br>${verdict}`;
            riskStat.innerText = `THREAT: ${threat}`;
            evStat.innerText = `VALUE: $${customEV}/hr`;
        }
    </script>
</body>
</html>
