<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Caddy</title>
    <style>
        /* 1. Nuke the Background */
        body, html {
            margin: 0;
            padding: 0;
            background: transparent;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
        }

        /* 2. The Floating Prodigy (The "Button") */
        #prodigy-icon {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
            background-image: url('/assets/caddy-mascot.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 10000;
            cursor: pointer;
            filter: drop-shadow(0 0 10px #BE00FC);
            transition: transform 0.2s ease, filter 0.2s ease;
        }

        /* Interaction Effect */
        #prodigy-icon:active {
            transform: scale(0.9);
            filter: drop-shadow(0 0 5px #00ff80);
        }

        /* 3. The Briefing Bubble (Hidden by default) */
        #intel-bubble {
            display: none;
            position: fixed;
            bottom: 120px;
            right: 20px;
            width: 260px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00ff80;
            border-left: 5px solid #00ff80;
            padding: 15px;
            border-radius: 4px;
            color: #00ff80;
            box-shadow: 0 0 20px rgba(0, 255, 128, 0.2);
            z-index: 9999;
        }

        /* Text Styles */
        h2 { margin: 0 0 10px 0; font-size: 14px; color: #BE00FC; text-transform: uppercase; }
        p { margin: 0; font-size: 12px; line-height: 1.4; color: #fff; }
        .stat-row { display: flex; justify-content: space-between; margin-top: 10px; font-size: 11px; color: #aaa; }
        
        /* The "Marshal" Red Alert Style */
        .alert-state {
            border-color: #ff3333 !important;
            border-left-color: #ff3333 !important;
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.4) !important;
        }
    </style>
</head>
<body>

    <div id="intel-bubble">
        <h2>Alliance Intel</h2>
        <p id="bubble-text">System Ready. Tap the Prodigy to deploy SnapScan.</p>
        <div class="stat-row">
            <span id="risk-stat">RISK: LOW</span>
            <span id="ev-stat">EV: --</span>
        </div>
    </div>

    <div id="prodigy-icon" onclick="toggleIntel()"></div>

    <script>
        const bubble = document.getElementById('intel-bubble');
        const text = document.getElementById('bubble-text');
        const riskStat = document.getElementById('risk-stat');
        const evStat = document.getElementById('ev-stat');
        
        let allianceStats = {};

        // Load Alliance Stats on init
        fetch('/api/alliance-stats')
            .then(res => res.json())
            .then(data => {
                allianceStats = data;
                console.log("Caddy: Alliance Stats Loaded.", Object.keys(allianceStats).length, "games");
            })
            .catch(e => console.error("Caddy: Failed to link to Alliance."));

        // 1. The Toggle Logic
        function toggleIntel() {
            if (bubble.style.display === 'block') {
                bubble.style.display = 'none';
                bubble.classList.remove('alert-state');
            } else {
                bubble.style.display = 'block';
                runSnapScan();
            }
        }

        // 2. Real SnapScan connected to CaddyCore
        async function runSnapScan() {
            text.innerText = "SCANNING CLIPBOARD...";
            riskStat.innerText = "RISK: --";
            evStat.innerText = "EV: --";
            bubble.classList.remove('alert-state');
            
            try {
                const rawText = await navigator.clipboard.readText();
                const gameTitle = rawText.toLowerCase().trim();
                
                setTimeout(() => {
                    const scoutReport = allianceStats[gameTitle];
                    
                    if (scoutReport) {
                        const isRisky = scoutReport.risk === 'high';
                        text.innerHTML = `TARGET: <b>${rawText.toUpperCase()}</b><br>STATUS: <b>${isRisky ? 'RIPCORD ADVISORY' : 'SANCTIONED'}</b><br>CLIFF: <b>${scoutReport.cliff}</b>`;
                        riskStat.innerText = `RISK: ${scoutReport.risk.toUpperCase()}`;
                        evStat.innerText = `EV: $${scoutReport.ev}/hr`;
                        
                        if (isRisky) {
                            bubble.classList.add('alert-state');
                        }
                    } else {
                        text.innerHTML = `TARGET: <b>${rawText.toUpperCase()}</b><br>STATUS: <b>UNKNOWN TERRAIN</b>`;
                        riskStat.innerText = "RISK: ???";
                        evStat.innerText = "EV: --";
                    }
                }, 600);
            } catch (err) {
                text.innerText = "CLIPBOARD ACCESS DENIED. Enable permissions.";
            }
        }
    </script>
</body>
</html>
